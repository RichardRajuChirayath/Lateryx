#!/bin/bash
# ============================================
# Lateryx Pre-Commit Hook
# ============================================
# Automatically scans your Terraform files for security issues
# before allowing a commit.
#
# INSTALLATION:
#   1. Copy this file to: .git/hooks/pre-commit
#   2. Make it executable: chmod +x .git/hooks/pre-commit
#
# Or use the install script:
#   python -m lateryx install-hook
# ============================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo -e "${YELLOW}ğŸ›¡ï¸  Lateryx Pre-Commit Security Check${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Find Terraform directories
TF_DIRS=$(find . -name "*.tf" -exec dirname {} \; 2>/dev/null | sort -u | head -5)

if [ -z "$TF_DIRS" ]; then
    echo -e "${GREEN}âœ… No Terraform files found. Skipping security scan.${NC}"
    exit 0
fi

# Check if lateryx is available
if ! python -c "from src.cli import main" 2>/dev/null; then
    echo -e "${YELLOW}âš ï¸  Lateryx not found in Python path. Skipping scan.${NC}"
    echo "   Install with: pip install -e ."
    exit 0
fi

# Scan each Terraform directory
HAS_ISSUES=false

for tf_dir in $TF_DIRS; do
    echo ""
    echo -e "${YELLOW}ğŸ“‚ Scanning: $tf_dir${NC}"
    
    # Run lateryx scan
    if ! python -m src.cli scan "$tf_dir" --fail-on-breach --severity HIGH; then
        HAS_ISSUES=true
    fi
done

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if [ "$HAS_ISSUES" = true ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘  âŒ COMMIT BLOCKED                                         â•‘${NC}"
    echo -e "${RED}â•‘  Security issues were detected in your infrastructure.     â•‘${NC}"
    echo -e "${RED}â•‘                                                            â•‘${NC}"
    echo -e "${RED}â•‘  Please fix the issues above before committing.            â•‘${NC}"
    echo -e "${RED}â•‘  To bypass (not recommended): git commit --no-verify       â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    exit 1
else
    echo -e "${GREEN}âœ… All security checks passed. Proceeding with commit.${NC}"
    echo ""
    exit 0
fi
